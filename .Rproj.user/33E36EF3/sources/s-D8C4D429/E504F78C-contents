---
title: "sarimaTD_example"
author: "Graham Casey Gibson"
date: "3/13/2020"
output: pdf_document
---

# An example of cdcForecastUtils for the sarimaTD model

First we load up sarimaTD and grab the cdc ILI data for Massachusetts.

```{r setup, include=T}
library(sarimaTD)
library(cdcForecastUtils)

flu_data <- download_and_preprocess_state_flu_data()
ma_data <- flu_data[flu_data$region == "Massachusetts",]
plot(ma_data$unweighted_ili,type='l')
```



We then fit sarimaTD up to the current date

```{r}

sarimaFit <- sarimaTD::fit_sarima(tail(ma_data$unweighted_ili,200),
                         ts_frequency = 52)

```


Next, we generate a matrix of nsim till end of season. In order to do that we first get the current date and figure out how many steps there are left in the current season. We know that the season ends on YYYY-EW20.

```{r}
current_date_in_cdc_format <-paste0(tail(ma_data$year,1),"-EW", ifelse(length(tail(ma_data$week,1))==2,tail(ma_data$week,1),paste0("0",tail(ma_data$week,1))))
season_end <- "2020-EW20"
time_left_in_season <- get_time_left_in_season(current_date_in_cdc_format,season_end)


preds <- simulate(
        object = sarimaFit,
        nsim = 1000,
        seed = 1,
        newdata = ma_data$unweighted_ili,
        h = time_left_in_season
      )
   
```

We next append the observed data from the current season which we know starts on YYYY-EW40 to the predictions to create a trajectory matrix. 


```{r}
season_start <- "2019-EW40"
time_from_start_of_season <- get_time_from_start_of_season(season_start,current_date_in_cdc_format)

trajectory_matrix <- cbind(matrix(rep(tail(ma_data$unweighted_ili,time_from_start_of_season),1000),nrow=1000,byrow = T),preds)

```

Finally, we convert the predicted trajectory matrix to a submission data frame.


```{r}
submission_df <- trajectories_to_short_term_and_seasonal_binned_distributions(trajectories = trajectory_matrix,
                                                             bins = c(seq(0,13,by=.1),100),
                                                             season_start = season_start,
                                                             season_end = season_end,
                                                             current_time=current_date_in_cdc_format,
                                                              nsim=1000,
                                                             h_max=6 )

head(submission_df)
```

